version: 2.1

jobs:
  deploy:
    docker:
      - image: google/cloud-sdk:slim

    environment:
      REGION: us-central1
      IMAGE_NAME: app

    steps:
      - checkout

      - setup_remote_docker

      # ---- Install tools ----
      - run:
          name: Install Docker + jq + curl
          command: |
            apt-get update
            apt-get install -y docker.io jq curl

      # -------- TOKEN EXCHANGE (OIDC -> STS -> GCP ACCESS TOKEN) --------
      - run:
          name: Get GCP Access Token via WIF
          command: |
            # STEP 1: CircleCI OIDC -> STS token
            STS_TOKEN=$(curl -s -X POST https://sts.googleapis.com/v1/token \
              -H "Content-Type: application/json" \
              -d "{
                \"audience\": \"//iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$WIF_POOL/providers/$WIF_PROVIDER\",
                \"grantType\": \"urn:ietf:params:oauth:grant-type:token-exchange\",
                \"requestedTokenType\": \"urn:ietf:params:oauth:token-type:access_token\",
                \"subjectTokenType\": \"urn:ietf:params:oauth:token-type:jwt\",
                \"subjectToken\": \"$CIRCLE_OIDC_TOKEN_V2\"
              }" | jq -r .access_token)

            # STEP 2: STS token -> Service Account access token
            ACCESS_TOKEN=$(curl -s -X POST \
              "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$SERVICE_ACCOUNT:generateAccessToken" \
              -H "Authorization: Bearer $STS_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{ "scope": ["https://www.googleapis.com/auth/cloud-platform"] }' \
              | jq -r .accessToken)

            echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $BASH_ENV

      # -------- DOCKER LOGIN --------
      - run:
          name: Docker Login
          command: |
            source $BASH_ENV
            echo "$ACCESS_TOKEN" | docker login -u oauth2accesstoken --password-stdin https://$REGION-docker.pkg.dev

      # -------- BUILD IMAGE --------
      - run:
          name: Build Docker Image
          command: |
            docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME .

      # -------- PUSH IMAGE --------
      - run:
          name: Push Docker Image
          command: |
            docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME

      # -------- DEPLOY CLOUD RUN --------
      - run:
          name: Deploy to Cloud Run
          command: |
            source $BASH_ENV

            gcloud auth activate-access-token $ACCESS_TOKEN

            gcloud run deploy my-service \
              --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME \
              --region $REGION \
              --allow-unauthenticated \
              --project $PROJECT_ID

workflows:
  deploy-workflow:
    jobs:
      - deploy
