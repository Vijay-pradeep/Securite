version: 2.1

jobs:
  deploy:
    docker:
      - image: google/cloud-sdk:slim

    environment:
      REGION: us-central1
      IMAGE_NAME: app

    steps:
      - checkout

      - setup_remote_docker

      # ---- Install Docker CLI + jq ----
      - run:
          name: Install Docker CLI and jq
          command: |
            apt-get update
            apt-get install -y docker.io jq

      # -------- AUTH WITH WIF --------
      - run:
          name: Authenticate with WIF
          command: |
            # Save CircleCI OIDC token to file
            echo "$CIRCLE_OIDC_TOKEN" > oidc_token.txt

            # Create external_account credentials JSON
            jq -n \
              --arg audience "//iam.googleapis.com/projects/930514070373/locations/global/workloadIdentityPools/circleci-pool/providers/circleci-provider" \
              --arg sa "circleci-sa@vijayproject-486406.iam.gserviceaccount.com" \
              '{
                type: "external_account",
                audience: $audience,
                subject_token_type: "urn:ietf:params:oauth:token-type:jwt",
                token_url: "https://sts.googleapis.com/v1/token",
                service_account_impersonation_url: "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/\($sa):generateAccessToken",
                credential_source: {
                  file: "oidc_token.txt",
                  format: { type: "text" }
                }
              }' > cred.json

            export GOOGLE_APPLICATION_CREDENTIALS="$PWD/cred.json"
            gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"

      # -------- BUILD DOCKER IMAGE --------
      - run:
          name: Build Docker Image
          command: |
            docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME .

      # -------- DOCKER LOGIN USING ACCESS TOKEN --------
      - run:
          name: Docker Login via Access Token
          command: |
            ACCESS_TOKEN=$(gcloud auth print-access-token)
            echo "$ACCESS_TOKEN" | docker login -u oauth2accesstoken --password-stdin https://$REGION-docker.pkg.dev

      # -------- PUSH IMAGE --------
      - run:
          name: Push Docker Image
          command: |
            docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME

      # -------- DEPLOY CLOUD RUN --------
      - run:
          name: Deploy to Cloud Run
          command: |
            gcloud run deploy my-service \
              --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME \
              --region $REGION \
              --allow-unauthenticated \
              --project $PROJECT_ID \
              --port=8080

      # -------- CAPTURE CLOUD RUN URL FOR DAST --------
      - run:
          name: Capture Cloud Run URL
          command: |
            URL=$(gcloud run services describe my-service \
              --region=$REGION \
              --project=$PROJECT_ID \
              --format='value(status.url)')
            echo "CLOUD_RUN_URL=${URL}"
            echo "CLOUD_RUN_URL=${URL}" > cloudrun_url.txt

      - persist_to_workspace:
          root: .
          paths:
            - cloudrun_url.txt


  # ---------- SAST JOB ----------
  sast:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout
      - run:
          name: Install dependencies (if Node app)
          command: |
            if [ -f package-lock.json ]; then
              npm ci
            elif [ -f package.json ]; then
              npm install
            else
              echo "No package.json found, skipping Node dependency install"
            fi
      - run:
          name: Run SAST (npm audit)
          command: |
            if [ -f package.json ]; then
              npm audit --audit-level=high
            else
              echo "No package.json, skipping npm audit"
            fi


  # ---------- SECRET SCAN JOB ----------
  secret-scan:
  docker:
    - image: alpine:3.20
  steps:
    - checkout
    - run:
        name: Install gitleaks
        command: |
          apk add --no-cache wget
          wget -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          mv gitleaks /usr/local/bin/gitleaks
    - run:
        name: Scan for secrets with gitleaks
        command: |
          gitleaks detect --source . --no-git -v



  # ---------- POLICY CHECK (OPA) ----------
  policy-check:
    docker:
      - image: openpolicyagent/opa:latest
    steps:
      - checkout
      - run:
          name: Run OPA policy checks (if policies exist)
          command: |
            if [ -d policy ]; then
              opa test policy/ -v
            else
              echo "No policy/ directory found, skipping OPA tests"
            fi


  # ---------- DAST (OWASP ZAP) ----------
  dast:
    docker:
      - image: owasp/zap2docker-stable
    steps:
      - attach_workspace:
          at: /workspace

      - run:
          name: Read Cloud Run URL
          command: |
            if [ ! -f /workspace/cloudrun_url.txt ]; then
              echo "cloudrun_url.txt not found; cannot run DAST"
              exit 1
            fi
            URL=$(grep CLOUD_RUN_URL /workspace/cloudrun_url.txt | cut -d'=' -f2)
            echo "Target URL: $URL"
            echo "$URL" > target_url.txt

      - run:
          name: Run OWASP ZAP baseline scan
          command: |
            TARGET=$(cat target_url.txt)
            echo "Running ZAP baseline scan against $TARGET"
            zap-baseline.py -t "$TARGET" -r zap-report.html || true

      - store_artifacts:
          path: zap-report.html
          destination: zap-report.html


workflows:
  deploy-workflow:
    jobs:
      - sast
      - secret-scan
      - policy-check
      - deploy:
          requires:
            - sast
            - secret-scan
            - policy-check
      - dast:
          requires:
            - deploy
