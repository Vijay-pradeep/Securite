version: 2.1

jobs:
  deploy:
    docker:
      - image: google/cloud-sdk:slim

    environment:
      REGION: us-central1
      IMAGE_NAME: app

    steps:
      - checkout

      - setup_remote_docker

      # ---- Install Docker CLI + jq ----
      - run:
          name: Install Docker CLI and jq
          command: |
            apt-get update
            apt-get install -y docker.io jq

      # -------- AUTH WITH WIF --------
      - run:
          name: Authenticate with WIF
          command: |
            # Save CircleCI OIDC token to file
            echo "$CIRCLE_OIDC_TOKEN" > oidc_token.txt

            # Create external_account credentials JSON
            jq -n \
              --arg audience "//iam.googleapis.com/projects/930514070373/locations/global/workloadIdentityPools/circleci-pool/providers/circleci-provider" \
              --arg sa "circleci-sa@vijayproject-486406.iam.gserviceaccount.com" \
              '{
                type: "external_account",
                audience: $audience,
                subject_token_type: "urn:ietf:params:oauth:token-type:jwt",
                token_url: "https://sts.googleapis.com/v1/token",
                service_account_impersonation_url: "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/\($sa):generateAccessToken",
                credential_source: {
                  file: "oidc_token.txt",
                  format: { type: "text" }
                }
              }' > cred.json

            export GOOGLE_APPLICATION_CREDENTIALS="$PWD/cred.json"
            gcloud auth login --cred-file="$GOOGLE_APPLICATION_CREDENTIALS"

      # -------- BUILD DOCKER IMAGE --------
      - run:
          name: Build Docker Image
          command: |
            docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME .

      # -------- DOCKER LOGIN USING ACCESS TOKEN --------
      - run:
          name: Docker Login via Access Token
          command: |
            ACCESS_TOKEN=$(gcloud auth print-access-token)
            echo "$ACCESS_TOKEN" | docker login -u oauth2accesstoken --password-stdin https://$REGION-docker.pkg.dev

      # -------- PUSH IMAGE --------
      - run:
          name: Push Docker Image
          command: |
            docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME

      # -------- DEPLOY CLOUD RUN --------
      - run:
          name: Deploy to Cloud Run
          command: |
            gcloud run deploy my-service \
              --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME \
              --region $REGION \
              --allow-unauthenticated \
              --project $PROJECT_ID \
              --port 8080

workflows:
  deploy-workflow:
    jobs:
      - deploy
